{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Pied Piper - The Simplest Chat Platform</title>
    <meta name="description" content="#">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap core CSS -->
    <link href="{% static 'dist/css/lib/bootstrap.min.css' %}" type="text/css" rel="stylesheet">
    <!-- Swipe core CSS -->
    <link href="{% static 'dist/css/swipe.min.css' %}" type="text/css" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Favicon -->
    <link href="{% static 'dist/img/favicon.png' %}" type="image/png" rel="icon">

    <style>
        /* ── Online status ── */
        .material-icons.online {
            color: #22c55e !important;
        }

        .status-online {
            color: #22c55e !important;
        }

        /* ── Unread message badge ── */
        .unread-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #ef4444;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            padding: 0 5px;
            line-height: 1;
            margin-left: auto;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(239, 68, 68, .45);
            animation: badgePop .2s ease;
        }

        .unread-badge.hidden {
            display: none;
        }

        @keyframes badgePop {
            from {
                transform: scale(0.6);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* keep person-add aligned in the same flex row */
        .contact .person-add {
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ── Dark theme ── */
        body,
        .navigation,
        .sidebar,
        .main,
        .chat,
        .top,
        .content,
        .bottom,
        .text,
        .contacts,
        .settings,
        .profile,
        .category,
        .title,
        .form-control,
        .list-group-item,
        a,
        .data h5,
        .data p,
        span,
        .dropdown-menu,
        .dropdown-item,
        input,
        textarea,
        .search {
            transition: background-color .25s ease, color .25s ease,
                border-color .25s ease, box-shadow .25s ease;
        }

        html.dark body {
            background-color: #0f0f13 !important;
            color: #e2e2e6 !important;
        }

        /* Navigation rail */
        html.dark .navigation {
            background-color: #1a1a24 !important;
            border-right: 1px solid #2a2a38 !important;
        }

        html.dark .navigation .btn,
        html.dark .navigation a {
            color: #a0a0b8 !important;
        }

        html.dark .navigation a:hover,
        html.dark .navigation .btn:hover {
            color: #e2e2e6 !important;
        }

        /* Sidebar */
        html.dark .sidebar {
            background-color: #16161f !important;
            border-right: 1px solid #2a2a38 !important;
        }

        html.dark .sidebar h1 {
            color: #b0b0cc !important;
        }

        html.dark .search .form-control {
            background-color: #222230 !important;
            border-color: #33334a !important;
            color: #e2e2e6 !important;
        }

        html.dark .search .form-control::placeholder {
            color: #666680 !important;
        }

        /* Contact list items */
        html.dark .contacts .list-group a.contact {
            background-color: transparent !important;
            border-bottom: 1px solid #22223a !important;
        }

        html.dark .contacts .list-group a.contact:hover,
        html.dark .contacts .list-group a.contact.active {
            background-color: #222230 !important;
        }

        html.dark .data h5 {
            color: #e2e2e6 !important;
        }

        html.dark .data p {
            color: #84849e !important;
        }

        /* Settings panel */
        html.dark .settings {
            background-color: #16161f !important;
        }

        html.dark .settings h1 {
            color: #b0b0cc !important;
        }

        html.dark .category {
            border-bottom: 1px solid #2a2a38 !important;
        }

        html.dark .title {
            color: #e2e2e6 !important;
        }

        html.dark .title p {
            color: #84849e !important;
        }

        /* Main area */
        html.dark .main {
            background-color: #0f0f13 !important;
        }

        /* Dropdown menus */
        html.dark .dropdown-menu {
            background-color: #1e1e2e !important;
            border-color: #2a2a3e !important;
        }

        html.dark .dropdown-item {
            color: #c0c0d8 !important;
        }

        html.dark .dropdown-item:hover {
            background-color: #2a2a3e !important;
            color: #fff !important;
        }

        /* Mode button glow in dark mode */
        html.dark .btn.mode .material-icons {
            color: #f0c060 !important;
            text-shadow: 0 0 8px rgba(240, 192, 96, .5);
        }
    </style>
</head>

<body>
    <main>
        <div class="layout">
            <!-- Start of Navigation -->
            <div class="navigation">
                <div class="container">
                    <div class="inside">
                        <div class="nav nav-tab menu">
                            <button class="btn" id="nav-avatar-btn">
                                <img class="avatar-xl" id="nav-avatar-img"
                                    src="{% if request.user.profile_picture %}{{ request.user.profile_picture.url }}{% else %}{% static 'dist/img/avatars/avatar-male-1.jpg' %}{% endif %}"
                                    alt="avatar">
                            </button>
                            <a href="#members" data-toggle="tab" class="active"><i
                                    class="material-icons">account_circle</i></a>
                            <!-- discussions & notifications hidden (same as chat page) -->
                            <button class="btn mode f-grow1" id="theme-toggle" title="Toggle dark mode"><i
                                    class="material-icons" id="theme-icon">brightness_2</i></button>
                            <a href="#settings" data-toggle="tab"><i class="material-icons">settings</i></a>
                            <form action="{% url 'logout' %}" method="post" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn power" title="Log out"><i
                                        class="material-icons">power_settings_new</i></button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End of Navigation -->

            <!-- Start of Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="container">
                    <div class="col-md-12">
                        <div class="tab-content">
                            <!-- Start of Contacts -->
                            <div class="tab-pane fade show active" id="members">
                                <div class="search">
                                    <form class="form-inline position-relative">
                                        <input type="search" class="form-control" id="people"
                                            placeholder="Search for people...">
                                        <button type="button" class="btn btn-link loop"><i
                                                class="material-icons">search</i></button>
                                    </form>
                                </div>
                                <div class="list-group sort">
                                    <button class="btn filterMembersBtn active show" data-toggle="list"
                                        data-filter="all">All</button>
                                    <button class="btn filterMembersBtn" data-toggle="list"
                                        data-filter="online">Online</button>
                                    <button class="btn filterMembersBtn" data-toggle="list"
                                        data-filter="offline">Offline</button>
                                </div>
                                <div class="contacts">
                                    <h1>Contacts</h1>
                                    <div class="list-group" id="contacts" role="tablist">
                                        {% for user in users %}
                                        <a href="{% url 'chat:chat_with_user' user.id %}"
                                            class="filterMembers all {% if user.is_online %}online{% else %}offline{% endif %} contact">
                                            <img class="avatar-md"
                                                src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'dist/img/avatars/avatar-female-1.jpg' %}{% endif %}"
                                                data-toggle="tooltip" data-placement="top" title="{{ user.username }}"
                                                alt="avatar">
                                            <div class="status">
                                                <i
                                                    class="material-icons {% if user.is_online %}online{% else %}offline{% endif %}">fiber_manual_record</i>
                                            </div>
                                            <div class="data">
                                                <h5>{{ user.username }}</h5>
                                                <p>{{ user.email }}</p>
                                            </div>
                                            <div class="person-add">
                                                <i class="material-icons">person</i>
                                                <span
                                                    class="unread-badge{% if not user.unread_count %} hidden{% endif %}"
                                                    id="unread-ul-{{ user.id }}"
                                                    title="{{ user.unread_count }} unread message{{ user.unread_count|pluralize }}">
                                                    {{ user.unread_count }}
                                                </span>
                                            </div>
                                        </a>
                                        {% empty %}
                                        <p>No other users found.</p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <!-- End of Contacts -->

                            <!-- Start of Settings -->
                            <div class="tab-pane fade" id="settings">
                                <div class="settings">
                                    <div class="profile">
                                        <img class="avatar-xl" id="settings-avatar-img"
                                            src="{% if request.user.profile_picture %}{{ request.user.profile_picture.url }}{% else %}{% static 'dist/img/avatars/avatar-male-1.jpg' %}{% endif %}"
                                            alt="avatar">
                                        <h1><a href="#" id="settings-username">{{ request.user.username }}</a></h1>
                                        <span id="settings-email">{{ request.user.email }}</span>
                                    </div>
                                    <div class="categories" id="accordionSettings">
                                        <h1>Settings</h1>

                                        <!-- ── My Account ── -->
                                        <div class="category" style="padding: 16px 0;">
                                            <div class="title"
                                                style="cursor:default; padding: 0; display:flex; align-items:center; gap:10px;">
                                                <i class="material-icons md-30"
                                                    style="color:#6c63ff;">manage_accounts</i>
                                                <div class="data">
                                                    <h5 style="margin:0;">My Account</h5>
                                                </div>
                                            </div>

                                            <form id="profile-form" style="margin-top:14px;"
                                                enctype="multipart/form-data">
                                                {% csrf_token %}

                                                <!-- Avatar upload -->
                                                <div
                                                    style="display:flex; flex-direction:column; align-items:center; gap:8px; margin-bottom:14px;">
                                                    <img id="avatar-preview"
                                                        src="{% if request.user.profile_picture %}{{ request.user.profile_picture.url }}{% else %}{% static 'dist/img/avatars/avatar-male-1.jpg' %}{% endif %}"
                                                        alt="preview"
                                                        style="width:72px; height:72px; border-radius:50%; object-fit:cover; border:3px solid #6c63ff; cursor:pointer;"
                                                        title="Click to change photo">
                                                    <input type="file" id="pic-input" name="profile_picture"
                                                        accept="image/*" style="display:none;">
                                                    <label for="pic-input"
                                                        style="font-size:12px; color:#6c63ff; cursor:pointer; margin:0;">Change
                                                        photo</label>
                                                </div>

                                                <!-- Username -->
                                                <div style="margin-bottom:10px;">
                                                    <label
                                                        style="font-size:12px; color:#9ca3af; display:block; margin-bottom:4px;">Username</label>
                                                    <input type="text" name="username" class="form-control"
                                                        value="{{ request.user.username }}" placeholder="Username"
                                                        style="border-radius:8px; font-size:14px;">
                                                </div>

                                                <!-- Email -->
                                                <div style="margin-bottom:14px;">
                                                    <label
                                                        style="font-size:12px; color:#9ca3af; display:block; margin-bottom:4px;">Email</label>
                                                    <input type="email" name="email" class="form-control"
                                                        value="{{ request.user.email }}" placeholder="Email"
                                                        style="border-radius:8px; font-size:14px;">
                                                </div>

                                                <div id="profile-msg"
                                                    style="font-size:13px; margin-bottom:8px; min-height:18px;"></div>

                                                <button type="submit" class="btn btn-primary btn-block"
                                                    style="background:#6c63ff; border:none; border-radius:8px; width:100%; padding:10px; font-weight:600;">
                                                    Save changes
                                                </button>
                                            </form>
                                        </div>

                                        <!-- ── Log out ── -->
                                        <div class="category">
                                            <form action="{% url 'logout' %}" method="post" style="width: 100%;">
                                                {% csrf_token %}
                                                <button type="submit" class="title collapsed"
                                                    style="border: none; background: none; width: 100%; text-align: left; padding: 20px 0;">
                                                    <i class="material-icons md-30 online">power_settings_new</i>
                                                    <div class="data">
                                                        <h5>Power Off</h5>
                                                        <p>Log out of your account</p>
                                                    </div>
                                                    <i class="material-icons">keyboard_arrow_right</i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- End of Settings -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- End of Sidebar -->

            <div class="main">
                <div class="tab-content" id="nav-tabContent">
                    <div class="babble tab-pane fade active show" id="list-chat" role="tabpanel"
                        aria-labelledby="list-chat-list">
                        <!-- Start of Chat -->
                        <div class="chat" id="chat1">
                            <div class="top">
                                <!-- Top bar placeholder -->
                            </div>
                            <div class="content empty">
                                <div class="container">
                                    <div class="col-md-12">
                                        <div class="no-messages">
                                            <i class="material-icons md-48">forum</i>
                                            <p>Select a contact to start chatting.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End of Chat -->
                    </div>
                </div>
            </div>
        </div> <!-- Layout -->
    </main>

    <!-- Bootstrap/Swipe core JavaScript -->
    <script src="{% static 'dist/js/jquery-3.3.1.slim.min.js' %}"></script>
    <script>window.jQuery || document.write('<script src="{% static "dist/js/vendor/jquery-slim.min.js" %}"><\/script>')</script>
    <script src="{% static 'dist/js/vendor/popper.min.js' %}"></script>
    <script src="{% static 'dist/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'dist/js/swipe.min.js' %}"></script>

    <script>
        const csrfToken = "{{ csrf_token }}";

        // ─── Dark / Light theme toggle ────────────────────────────────────────
        (function () {
            const html = document.documentElement;
            const toggleBtn = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');

            function applyTheme(theme) {
                if (theme === 'dark') {
                    html.classList.add('dark');
                    themeIcon.textContent = 'brightness_7';
                    toggleBtn.title = 'Switch to light mode';
                } else {
                    html.classList.remove('dark');
                    themeIcon.textContent = 'brightness_2';
                    toggleBtn.title = 'Switch to dark mode';
                }
            }

            const saved = localStorage.getItem('chatTheme') || 'light';
            applyTheme(saved);

            toggleBtn.addEventListener('click', function () {
                const next = html.classList.contains('dark') ? 'light' : 'dark';
                applyTheme(next);
                localStorage.setItem('chatTheme', next);
            });
        })();

        // ─── My Account – profile form ────────────────────────────────────────
        (function () {
            const picInput = document.getElementById('pic-input');
            const avatarPreview = document.getElementById('avatar-preview');
            const profileForm = document.getElementById('profile-form');
            const profileMsg = document.getElementById('profile-msg');

            // Clicking the preview image opens the file picker
            if (avatarPreview) {
                avatarPreview.addEventListener('click', function () { picInput.click(); });
            }

            // Live-preview chosen image before saving
            if (picInput) {
                picInput.addEventListener('change', function () {
                    const file = picInput.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function (e) { avatarPreview.src = e.target.result; };
                    reader.readAsDataURL(file);
                });
            }

            function updateAllAvatars(newUrl) {
                if (!newUrl) return;
                ['nav-avatar-img', 'settings-avatar-img', 'avatar-preview'].forEach(function (id) {
                    const el = document.getElementById(id);
                    if (el) el.src = newUrl + '?t=' + Date.now();
                });
            }

            if (profileForm) {
                profileForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    profileMsg.textContent = '';
                    profileMsg.style.color = '';

                    const formData = new FormData(profileForm);

                    fetch('/auth/profile/update/', {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken },
                        body: formData,
                    })
                        .then(function (r) { return r.json().then(function (d) { return { ok: r.ok, data: d }; }); })
                        .then(function (res) {
                            if (!res.ok) {
                                const errs = res.data.errors || {};
                                profileMsg.style.color = '#ef4444';
                                profileMsg.textContent = Object.values(errs).join(' ');
                                return;
                            }
                            const d = res.data;
                            const uEl = document.getElementById('settings-username');
                            const eEl = document.getElementById('settings-email');
                            if (uEl) uEl.textContent = d.username;
                            if (eEl) eEl.textContent = d.email;
                            if (d.picture_url) updateAllAvatars(d.picture_url);

                            profileMsg.style.color = '#22c55e';
                            profileMsg.textContent = '✓ Profile updated!';
                            setTimeout(function () { profileMsg.textContent = ''; }, 3000);
                        })
                        .catch(function (err) {
                            console.error('Profile update error:', err);
                            profileMsg.style.color = '#ef4444';
                            profileMsg.textContent = 'Something went wrong. Please try again.';
                        });
                });
            }
        })();
    </script>
</body>

</html>